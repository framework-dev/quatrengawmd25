<!doctype html>
<notebook theme="air">
  <title>Quatrenga WMD Fallâ€™25 0.1</title>
  <script id="0" type="text/html">
    <div class="responsive-container" id="renga-grid">
      ${gridHTML}
    </div>
  </script>
  <script id="1" type="module" hidden="">
    const buildGridHTML = () => {
      const allCells = [];
      let cellIndex = 0;

      // Get the first row (headers) from rengaData
      if (rengaData && rengaData.length > 0) {
        const headers = Object.keys(rengaData[0]);

        // Add header row
        headers.forEach(header => {
          cellIndex++;
          const cell = htl.html`<div class="grid-cell">${header}</div>`;

          // Add individual hover listener for all cells
          cell.addEventListener('mouseenter', () => {
            if (cell.dataset.isBold) {
              cell.style.color = 'white';
            } else {
              cell.style.color = ''; // Reset to default
            }
          });
          cell.addEventListener('mouseleave', () => {
            cell.style.color = ''; // Reset to default
          });

          // Add verse highlighting listener if this cell number is a key in showVerseTable
          if (showVerseTable[state.currentIndex].has(cellIndex)) {
            const currentCellNum = cellIndex;
            cell.addEventListener('mouseenter', () => highlightVerses(currentCellNum));
            cell.addEventListener('mouseleave', () => resetHighlights());
          }

          allCells.push(cell);
        });

        // Add data rows
        rengaData.forEach(row => {
          headers.forEach(header => {
            cellIndex++;
            const content = row[header] || '';

            // Check if content has <b> tags
            let cell;
            const hasBoldTag = content.includes('<b>');
            content.replace(/<b>/g, '');

            let lines = content.split('<br>');

            // if (hasBoldTag) {
            const tempDiv = document.createElement('div');
            tempDiv.className = 'grid-cell';
            lines.forEach((line, index) => {
              const lineDiv = document.createElement('div');
              if (hasBoldTag) {
                lineDiv.style.fontWeight = 'medium';
              }
              lineDiv.innerHTML = line;
              tempDiv.appendChild(lineDiv);

              // Store reference to check after render
              setTimeout(() => {
                // Create a test span to measure single-line height
                const testSpan = document.createElement('span');
                testSpan.style.visibility = 'hidden';
                testSpan.style.position = 'absolute';
                testSpan.innerHTML = 'X';
                lineDiv.appendChild(testSpan);
                const singleLineHeight = testSpan.offsetHeight;
                lineDiv.removeChild(testSpan);

                // If lineDiv height is greater than single line, it wrapped
                if (lineDiv.offsetHeight > singleLineHeight * 1.2) {
                  lineDiv.style.textAlignLast = 'right';
                }
              }, 0);
            });
            tempDiv.style.color = ''; // Reset to default
            tempDiv.dataset.isBold = 'true';
            cell = tempDiv;
            // } else {
            //   // Replace <br> tags with actual line breaks for plain text
            //   const formattedContent = content.replace(/<br>/g, '\n');
            //   cell = htl.html`<div class="grid-cell">${formattedContent}</div>`;
            // }

            // Add individual hover listener for all cells
            cell.addEventListener('mouseenter', () => {
              if (cell.dataset.isBold) {
                cell.style.color = 'white';
              } else {
                cell.style.color = ''; // Reset to default
              }
            });
            cell.addEventListener('mouseleave', () => {
              cell.style.color = ''; // Reset to default
            });

            // Add verse highlighting listener if this cell number is a key in showVerseTable
            if (showVerseTable[state.currentIndex].has(cellIndex)) {
              const currentCellNum = cellIndex;
              cell.addEventListener('mouseenter', () => highlightVerses(currentCellNum));
              cell.addEventListener('mouseleave', () => resetHighlights());
            }

            allCells.push(cell);
          });
        });
      }

      return allCells;
    }
    let gridHTML = buildGridHTML();

    // Add keyboard listener for left/right arrow navigation
    document.addEventListener('keydown', (event) => {
      if (event.key === 'ArrowLeft') {
        state.currentIndex = mod(state.currentIndex - 1, tsvTable.length);
        rebuildGrid();
      } else if (event.key === 'ArrowRight') {
        state.currentIndex = mod(state.currentIndex + 1, tsvTable.length);
        rebuildGrid();
      }
    });

    function rebuildGrid() {
      // Re-parse data with new index
      const newRengaData = parseTsvToJson(tsvTable[state.currentIndex]);

      // Update the global rengaData
      Object.assign(rengaData, newRengaData);
      rengaData.length = newRengaData.length;

      // Rebuild the grid
      gridHTML = buildGridHTML();

      // Update the DOM
      const container = document.getElementById('renga-grid');
      if (container) {
        container.innerHTML = '';
        gridHTML.forEach(cell => container.appendChild(cell));
      }
    }
  </script>
  <script id="2" type="module" hidden="">
    const showVerseTable = [new Map([
      [1, [2,3,4,5,6,7,8]],
      [2, [10,18,26,34,42,50,58]],
      [3, [11,19,27,35,43,51,59]],
      [4, [12,20,28,36,44,52,60]],
      [5, [13,21,29,37,45,53,61]],
      [6, [14,22,30,38,46,54,62]],
      [7, [15,23,31,39,47,55,63]],
      [8, [16,24,32,40,48,56,64]],
      [9, [10,11,12,13,14,15,16]],
      [17, [10,18,19,20,21,22,23,24]],
      [25, [24,10,26,27,28,29,30,31,32]],
      [33, [31,24,10,34,35,36,37,38,39,40]],
      [41, [37,31,24,10,42,43,44,45,46,47,48]],
      [49, [44,37,31,24,10,50,51,52,53,54,55,56]],
      [57, [50,44,37,31,24,10,58,59,60,61,62,63,64]],
      [10, [24,31,37,44,50,60]],
      [24, [10,31,37,44,50,60]],
      [31, [10,24,37,44,50,60]],
      [37, [10,24,31,44,50,60]],
      [44, [10,24,31,37,50,60]],
      [50, [10,24,31,37,44,60]],
      [60, [10,24,31,37,44,50]],
      [18, [10]],
      [19, [10]],
      [20, [10]],
      [21, [10]],
      [22, [10]],
      [23, [10]],
      [26, [24, 10]],
      [27, [24, 10]],
      [28, [24, 10]],
      [29, [24, 10]],
      [30, [24, 10]],
      [34, [31, 24, 10]],
      [35, [31, 24, 10]],
      [36, [31, 24, 10]],
      [38, [31, 24, 10]],
      [39, [31, 24, 10]],
      [40, [31, 24, 10]],
      [42, [37, 31, 24, 10]],
      [43, [37, 31, 24, 10]],
      [45, [37, 31, 24, 10]],
      [46, [37, 31, 24, 10]],
      [47, [37, 31, 24, 10]],
      [48, [37, 31, 24, 10]],
      [51, [44, 37, 31, 24, 10]],
      [52, [44, 37, 31, 24, 10]],
      [53, [44, 37, 31, 24, 10]],
      [54, [44, 37, 31, 24, 10]],
      [55, [44, 37, 31, 24, 10]],
      [56, [44, 37, 31, 24, 10]],
      [58, [50, 44, 37, 31, 24, 10]],
      [59, [50, 44, 37, 31, 24, 10]],
      [61, [50, 44, 37, 31, 24, 10]],
      [62, [50, 44, 37, 31, 24, 10]],
      [63, [50, 44, 37, 31, 24, 10]],
      [64, [50, 44, 37, 31, 24, 10]]
    ]),new Map([
      [1, [2,3,4,5,6,7,8]],
      [2, [10,18,26,34,42,50,58]],
      [3, [11,19,27,35,43,51,59]],
      [4, [12,20,28,36,44,52,60]],
      [5, [13,21,29,37,45,53,61]],
      [6, [14,22,30,38,46,54,62]],
      [7, [15,23,31,39,47,55,63]],
      [8, [16,24,32,40,48,56,64]],
      [9, [10,11,12,13,14,15,16]],
      [17, [10,18,19,20,21,22,23,24]],
      [25, [24,10,26,27,28,29,30,31,32]],
      [33, [31,24,10,34,35,36,37,38,39,40]],
      [41, [37,31,24,10,42,43,44,45,46,47,48]],
      [49, [44,37,31,24,10,50,51,52,53,54,55,56]],
      [57, [50,44,37,31,24,10,58,59,60,61,62,63,64]],
      [14, [24,32,37,43,56,61]],
      [24, [14,32,37,43,56,61]],
      [32, [14,24,37,43,56,61]],
      [37, [14,24,32,43,56,61]],
      [43, [14,24,32,37,56,61]],
      [56, [14,24,32,37,43,61]],
      [61, [14,24,32,37,43,56]],
      [18, [14]],
      [19, [14]],
      [20, [14]],
      [21, [14]],
      [22, [14]],
      [23, [14]],
      [26, [24, 10]],
      [27, [24, 10]],
      [28, [24, 10]],
      [29, [24, 10]],
      [30, [24, 10]],
      [34, [31, 24, 10]],
      [35, [31, 24, 10]],
      [36, [31, 24, 10]],
      [38, [31, 24, 10]],
      [39, [31, 24, 10]],
      [40, [31, 24, 10]],
      [42, [37, 31, 24, 10]],
      [43, [37, 31, 24, 10]],
      [45, [37, 31, 24, 10]],
      [46, [37, 31, 24, 10]],
      [47, [37, 31, 24, 10]],
      [48, [37, 31, 24, 10]],
      [51, [44, 37, 31, 24, 10]],
      [52, [44, 37, 31, 24, 10]],
      [53, [44, 37, 31, 24, 10]],
      [54, [44, 37, 31, 24, 10]],
      [55, [44, 37, 31, 24, 10]],
      [56, [44, 37, 31, 24, 10]],
      [58, [50, 44, 37, 31, 24, 10]],
      [59, [50, 44, 37, 31, 24, 10]],
      [61, [50, 44, 37, 31, 24, 10]],
      [62, [50, 44, 37, 31, 24, 10]],
      [63, [50, 44, 37, 31, 24, 10]],
      [64, [50, 44, 37, 31, 24, 10]]
    ])
      ];
  </script>
  <script id="3" type="module" hidden="">
    function parseTsvToJson(tsvString) {
      const lines = tsvString.trim().split('\n');
      const headers = lines[0].split('\t').map(h => h.trim());

      const result = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split('\t').map(v => v.trim());
        const row = {};

        for (let j = 0; j < headers.length; j++) {
          row[headers[j]] = values[j] || '';
        }

        result.push(row);
      }

      return result;
    }

    // Parse the TSV data
    const rengaData = parseTsvToJson(tsvTable[state.currentIndex]);
  </script>
  <script id="4" type="module" hidden="">
    const state = { currentIndex: 0 }
  </script>
  <script id="5" type="module">
    const tsvTable = [`Poet	Andrew	Isa	John	Minh Khue	Pranavi	Sehee	TJ
    Sehee	<b>wind</b>	moon 	cloud	sea	gravity	thunder	star
    Isa	flows	whistles 	keens	blows	billows	sings	<b>softens</b>
    Minh Khue	dogs	barn owls	flies	sea cucumbers	cranes	<b>seagulls</b>	lady bugs
    John	dive	caw	alight	<b>steal</b>	perch	chirp	glide
    Pranavi	sunset	rain 	<b>tide</b>	lightning	storm	snow	wave
    TJ	<b>swells</b>	lowers 	ebbs	crashes	retracts	thuds	flows
    Andrew	below	marsh	<b>home</b>	earth	ocean	trees	here`,
      `Poet	Andrew	Isa	John	Minh Khue	Pranavi	Sehee	TJ
    Sehee	cliff	mud 	stream	estuary	<b>fire</b>	flood	boulder
    Minh Khue	road	glistens	glow	spray	burning	embers	<b>sparks</b>
    John	barbeque	combustion 	sitting	festival	memory	parade	<b>lies</b>
    Isa	hide	promised	burn	<b>entangle</b>	deception	observed	trust
    TJ	must	<b>secrecy</b> 	through	dancing	afterglow	forever	falter
    Pranavi	what	withheld 	terror	burns 	contempt	left	<b>hope</b>
    Andrew	now	history 	unending	<b>within</b>	forgetting	alone	less`];
  </script>
  <script id="6" type="module" hidden="">
    let highlightedCells = [];

    function highlightVerses(key) {
      const verses = showVerseTable[state.currentIndex].get(key);

      if (verses === undefined) {
        console.log(`Key ${key} not found in showVerseTable`);
        return;
      }

      // Get all grid cells
      const gridCells = document.querySelectorAll('#renga-grid .grid-cell');

      // Track which cells we're highlighting
      highlightedCells = [key, ...verses];

      // Highlight the key cell (subtract 1 because cells are 0-indexed)
      if (gridCells[key - 1]) {
        const cell = gridCells[key - 1];
        // Bold cells turn white, non-bold cells turn floralwhite
        cell.style.color = cell.dataset.isBold ? 'white' : 'floralwhite';
      }

      // Highlight all cells in the verses array
      verses.forEach(cellNum => {
        if (gridCells[cellNum - 1]) {
          const cell = gridCells[cellNum - 1];
          // Bold cells turn white, non-bold cells turn floralwhite
          cell.style.color = cell.dataset.isBold ? 'white' : 'floralwhite';  // not bold reset to default
        }
      });
    }

    function resetHighlights() {
      const gridCells = document.querySelectorAll('#renga-grid .grid-cell');

      // Only reset the cells that were just highlighted
      highlightedCells.forEach(cellNum => {
        if (gridCells[cellNum - 1]) {
          const cell = gridCells[cellNum - 1];
          // All cells return to black
          cell.style.color = ''; // Reset to default
        }
      });

      highlightedCells = [];
    }

    // Example usage:
    // highlightVerses(1);  // Highlights cell 1 and cells 2,3,4,5,6,7,8
    // highlightVerses(17); // Highlights cell 17 and cells 14,18,19,20,21,22,23,24

    function mod (n, m) {
      // mod function that handles negative numbers, usage: mod(num, modulous)
      return ((n % m) + m) % m;
    }
  </script>
</notebook>
